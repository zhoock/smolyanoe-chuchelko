# Локальная разработка социальной сети с мультитенантностью

## Описание

Система поддержки поддоменов для локальной разработки позволяет каждому пользователю иметь свой личный кабинет на отдельном поддомене:

- `user1.localhost:8888` - личный кабинет пользователя с email `user1@example.com`
- `user2.localhost:8888` - личный кабинет пользователя с email `user2@example.com`
- `localhost:8888` - главный домен (без поддомена)

## Как это работает

### На сервере (Netlify Functions)

1. **Определение пользователя из поддомена** (`netlify/functions/lib/subdomain-helpers.ts`):
   - Извлекает subdomain из `Host` заголовка
   - Ищет пользователя в БД по email (часть до `@` совпадает с subdomain)
   - Возвращает `userId` найденного пользователя

2. **Модифицированные API endpoints**:
   - `albums.ts` - фильтрует альбомы по `userId` из поддомена (в dev режиме)
   - `user-profile.ts` - загружает профиль пользователя из поддомена
   - Используют `getUserIdFromSubdomainOrEvent()` вместо `getUserIdFromEvent()`

### На клиенте (React)

1. **Утилиты для работы с поддоменами** (`src/shared/lib/subdomain.ts`):
   - `getCurrentSubdomain()` - получает текущий subdomain
   - `redirectToSubdomain()` - перенаправляет на поддомен пользователя
   - `createSubdomainUrl()` - создает URL для поддомена

2. **Автоматический редирект после регистрации/входа**:
   - После успешной регистрации/входа пользователь автоматически перенаправляется на свой поддомен
   - Subdomain извлекается из email (часть до `@`)

3. **Hero компонент**:
   - Загружает данные пользователя из поддомена автоматически
   - В dev режиме может работать без токена (API определяет пользователя по subdomain)

## Как использовать

### 1. Регистрация нового пользователя

При регистрации с email `user1@example.com`:

- После успешной регистрации автоматически произойдет редирект на `user1.localhost:8888`
- Пользователь увидит только свой контент (альбомы, статьи, профиль)

### 2. Вход пользователя

При входе с email `user2@example.com`:

- После успешного входа автоматически произойдет редирект на `user2.localhost:8888`
- Пользователь увидит только свой контент

### 3. Работа с контентом

- Все альбомы и статьи автоматически фильтруются по `userId` из поддомена
- Каждый пользователь видит только свой контент
- Hero изображения и название группы загружаются из профиля пользователя

## Важные замечания

1. **Только для dev режима**: Поддомены работают только локально (`localhost`). В продакшене используется стандартная авторизация через JWT токены.

2. **Subdomain = email prefix**: Subdomain должен совпадать с частью email до `@`. Например:
   - Email: `user1@example.com` → Subdomain: `user1`
   - Email: `test@test.ru` → Subdomain: `test`

3. **DNS не требуется**: Браузер автоматически разрешает `*.localhost` на `127.0.0.1`, поэтому дополнительной настройки DNS не требуется.

4. **Порт**: Используется порт из `netlify.toml` (по умолчанию 8888).

## Ограничения

- Поддомены работают только с `localhost`, не с `127.0.0.1`
- Для каждого пользователя должен существовать поддомен = часть email до `@`
- В продакшене поддомены не используются, все работает через JWT токены
