# –ß–µ–∫–ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.

## ‚úÖ –®–∞–≥ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

```bash
npm run generate-encryption-key
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—ã –ø–æ–ª—É—á–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ `ENCRYPTION_KEY=xxx...`

**–í–∞–∂–Ω–æ:** –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–ª—é—á –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ!

## ‚úÖ –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 2.1. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ PostgreSQL –∏ —Å–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:

```sql
CREATE DATABASE your_database_name;
```

### 2.2. –ü–æ–ª—É—á–µ–Ω–∏–µ DATABASE_URL

–°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```
postgresql://username:password@host:port/database_name?sslmode=require
```

**–ü—Ä–∏–º–µ—Ä—ã:**

- –õ–æ–∫–∞–ª—å–Ω–æ: `postgresql://postgres:password@localhost:5432/payment_db`
- Supabase: `postgresql://postgres:password@db.xxxxx.supabase.co:5432/postgres`
- Neon: `postgresql://user:pass@ep-xxxxx.us-east-2.aws.neon.tech/neondb?sslmode=require`

## ‚úÖ –®–∞–≥ 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### 3.1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
export DATABASE_URL="postgresql://username:password@host:port/database"
```

### 3.2. –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
npm run migrate
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
üöÄ Starting database migrations...
‚úÖ Database connection successful
üìã Found 1 migration(s)
üìù Running migration: 001_create_payment_settings.sql
‚úÖ Migration 001_create_payment_settings.sql completed successfully

‚ú® Migration completed!
   Executed: 1
   Skipped: 0
   Total: 1
```

## ‚úÖ –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Netlify

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Netlify Dashboard** ‚Üí –í–∞—à –ø—Ä–æ–µ–∫—Ç ‚Üí **Site settings** ‚Üí **Environment variables**

2. –î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è            | –ó–Ω–∞—á–µ–Ω–∏–µ                              | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| --------------------- | ------------------------------------- | ------------------------------------ |
| `DATABASE_URL`        | `postgresql://...`                    | –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL      |
| `ENCRYPTION_KEY`      | `xxx...` (–∏–∑ —à–∞–≥–∞ 1)                  | –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è secretKey        |
| `YOOKASSA_SHOP_ID`    | –í–∞—à shopId                            | ID –º–∞–≥–∞–∑–∏–Ω–∞ –ÆKassa (–¥–ª—è fallback)    |
| `YOOKASSA_SECRET_KEY` | –í–∞—à secretKey                         | –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –ÆKassa (–¥–ª—è fallback) |
| `YOOKASSA_API_URL`    | `https://api.yookassa.ru/v3/payments` | URL API –ÆKassa (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)         |

3. –ù–∞–∂–º–∏—Ç–µ **Save**

**–í–∞–∂–Ω–æ:**

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π (Production, Deploy previews, Branch deploys)
- –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Git!

## ‚úÖ –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

### 5.1. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
export DATABASE_URL="postgresql://username:password@host:port/database"
export ENCRYPTION_KEY="your-key-from-step-1"
npm run test-db
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
üîç Testing database connection...
‚úÖ Connected to PostgreSQL: PostgreSQL 15.x
‚úÖ Table user_payment_settings exists
‚úÖ Encryption/decryption working correctly
‚ú® All tests completed successfully!
```

### 5.2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Netlify Functions

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Netlify Functions:

1. **Netlify Dashboard** ‚Üí –í–∞—à –ø—Ä–æ–µ–∫—Ç ‚Üí **Functions** ‚Üí **Logs**
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ API
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

## ‚úÖ –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π

### 6.1. –¢–µ—Å—Ç —á–µ—Ä–µ–∑ UI

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ñ–æ—Ä–º–æ–π –ø–æ–∫—É–ø–∫–∏
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ —à–∞–≥—É "Payment"
3. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
4. –ù–∞–∂–º–∏—Ç–µ "Pay"
5. –î–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ÆKassa

### 6.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

**Netlify Dashboard** ‚Üí **Functions** ‚Üí **Logs** ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- ‚úÖ `create-payment` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ `payment-settings` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ `payment-webhook` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –ÆKassa

## ‚úÖ –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –æ—Ç –ÆKassa

1. –û—Ç–∫—Ä–æ–π—Ç–µ **–ÆKassa Dashboard** ‚Üí **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
2. –î–æ–±–∞–≤—å—Ç–µ URL:
   ```
   https://your-site.netlify.app/.netlify/functions/payment-webhook
   ```
3. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - ‚úÖ `payment.succeeded` - –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω
   - ‚úÖ `payment.canceled` - –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ß–µ–∫–ª–∏—Å—Ç:

- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –¢–∞–±–ª–∏—Ü–∞ `user_payment_settings` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ Netlify
- [ ] –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- [ ] –¢–µ—Å—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Webhook URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ÆKassa
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ

## üÜò Troubleshooting

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

```
‚ùå Error: connect ECONNREFUSED
```

**–†–µ—à–µ–Ω–∏–µ:**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (–¥–ª—è Netlify)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall –ø—Ä–∞–≤–∏–ª–∞

### –û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

```
‚ùå Decryption failed
```

**–†–µ—à–µ–Ω–∏–µ:**

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `ENCRYPTION_KEY` –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
- –ö–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ base64 (44 —Å–∏–º–≤–æ–ª–∞)
- –ù–µ –º–µ–Ω—è–π—Ç–µ –∫–ª—é—á –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!

### –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ÆKassa

```
‚ùå Invalid YooKassa credentials
```

**–†–µ—à–µ–Ω–∏–µ:**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `shopId` –∏ `secretKey`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–∫–∫–∞—É–Ω—Ç –ÆKassa –∞–∫—Ç–∏–≤–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API URL (test/production)

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã](./payment-architecture.md)
- [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa](./yookassa-integration.md)
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](./database-setup.md)
