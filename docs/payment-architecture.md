# Архитектура платежной системы

## Текущая ситуация (для покупателей)

### Как работает сейчас

**Покупателю НЕ нужен аккаунт ЮKassa:**

1. Покупатель выбирает альбом на сайте
2. Нажимает кнопку "Скачать" → открывается форма покупки
3. Заполняет данные карты (в форме на сайте)
4. Нажимает "Оплатить" → перенаправляется на страницу оплаты ЮKassa
5. Вводит данные карты на сайте ЮKassa (без регистрации)
6. После оплаты возвращается на сайт и получает доступ к скачиванию

**Аккаунт ЮKassa нужен только владельцу сайта (продавцу)** для получения денег.

### Сейчас на сайте (для покупателей)

✅ **Готово:**

- Форма ввода данных карты
- Валидация и форматирование полей
- Интеграция с ЮKassa API
- Перенаправление на страницу оплаты ЮKassa
- Обработка webhook от ЮKassa

✅ **Покупателю НЕ нужно:**

- Регистрироваться в ЮKassa
- Иметь аккаунт ЮKassa
- Переходить в личный кабинет ЮKassa

## Будущая архитектура (для музыкантов-продавцов)

### Вариант 1: Единый аккаунт платформы (проще)

**Архитектура:**

- Один аккаунт ЮKassa у владельца платформы
- Все платежи идут на этот аккаунт
- Владелец платформы распределяет деньги между музыкантами

**Что нужно сделать:**

1. ✅ Уже сделано: единый аккаунт в Netlify переменных окружения
2. Нужно добавить:
   - Базу данных для хранения балансов музыкантов
   - API для распределения денег между музыкантами
   - Интерфейс в кабинете музыканта для просмотра баланса

**Плюсы:**

- Музыканту не нужно регистрироваться в ЮKassa
- Проще настроить (один аккаунт)
- Владелец платформы контролирует все платежи

**Минусы:**

- Владелец платформы получает все деньги и должен распределять
- Нужна система внутренних переводов

### Вариант 2: Индивидуальные аккаунты музыкантов (правильнее)

**Архитектура:**

- Каждый музыкант имеет свой аккаунт ЮKassa
- Каждый музыкант получает свои деньги напрямую
- Платформа использует аккаунт музыканта для создания платежей

**Что нужно сделать:**

#### 1. Подготовка на сайте (сейчас)

✅ **Уже готово:**

- API для создания платежей (`/api/create-payment`)
- Поддержка разных `shopId` и `secretKey` в функции

#### 2. В кабинете музыканта (будущее)

**Раздел "Настройки платежей"** (как на скриншоте):

```
┌─────────────────────────────────────┐
│ Настройки платежей                  │
├─────────────────────────────────────┤
│                                      │
│ [ЮKassa логотип]                     │
│                                      │
│ Подключите свой аккаунт ЮKassa,     │
│ чтобы получать платежи напрямую.     │
│                                      │
│ Для получения платежей вам           │
│ потребуется бизнес-счёт ЮKassa.      │
│                                      │
│ [Подключиться к ЮKassa]             │
│                                      │
└─────────────────────────────────────┘
```

**Процесс подключения:**

1. **Кнопка "Подключиться к ЮKassa"** → перенаправляет на страницу авторизации ЮKassa
2. **Музыкант авторизуется** в ЮKassa (или регистрируется, если нет аккаунта)
3. **ЮKassa запрашивает разрешение** на доступ к аккаунту музыканта
4. **После подтверждения** → возврат на сайт с `shopId` и `secretKey`
5. **Сохранение в БД** → привязка аккаунта ЮKassa к аккаунту музыканта
6. **Готово** → музыкант может принимать платежи

#### 3. Техническая реализация

**База данных:**

```typescript
interface UserPaymentSettings {
  userId: string;
  paymentProvider: 'yookassa' | 'stripe' | 'paypal';
  shopId?: string; // Для ЮKassa
  secretKey?: string; // Зашифровано в БД
  isActive: boolean;
  connectedAt: Date;
  lastUsedAt?: Date;
}
```

**API для подключения:**

```typescript
// POST /api/connect-payment-provider
// Авторизация через OAuth ЮKassa
// Сохранение shopId и secretKey в БД

// GET /api/payment-settings
// Получение настроек платежей пользователя

// PUT /api/payment-settings
// Обновление настроек платежей
```

**Обновление функции создания платежа:**

```typescript
// В create-payment.ts
// Вместо:
const shopId = process.env.YOOKASSA_SHOP_ID;
const secretKey = process.env.YOOKASSA_SECRET_KEY;

// Нужно:
const userId = request.body.userId; // ID музыканта
const userPaymentSettings = await getUserPaymentSettings(userId);
const shopId = userPaymentSettings.shopId;
const secretKey = decrypt(userPaymentSettings.secretKey);
```

## Что нужно сделать сейчас для будущей интеграции

### 1. Подготовить структуру БД

```sql
CREATE TABLE user_payment_settings (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  provider VARCHAR(20) NOT NULL, -- 'yookassa', 'stripe', 'paypal'
  shop_id VARCHAR(255),
  secret_key_encrypted TEXT, -- Зашифрованный ключ
  is_active BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 2. Подготовить API endpoints

**Файлы для создания:**

- `/netlify/functions/connect-payment.ts` - OAuth авторизация ЮKassa
- `/netlify/functions/payment-settings.ts` - CRUD для настроек платежей
- `/netlify/functions/get-payment-settings.ts` - Получение настроек

### 3. Обновить функцию создания платежа

Модифицировать `/netlify/functions/create-payment.ts`:

- Принимать `userId` в запросе
- Получать `shopId` и `secretKey` из БД для конкретного пользователя
- Если у пользователя нет аккаунта → использовать аккаунт платформы по умолчанию

### 4. Создать UI в кабинете пользователя

**Компоненты:**

- `/src/pages/UserDashboard/PaymentSettings.tsx`
- `/src/pages/UserDashboard/PaymentSettings.style.scss`

**Структура:**

- Список доступных платежных систем (ЮKassa, Stripe, PayPal)
- Карточка для каждой системы с описанием
- Кнопка "Подключить" → OAuth авторизация
- Статус подключения (подключено / не подключено)
- Кнопка "Отключить"

## Резюме

### Для покупателя (сейчас работает)

✅ **Не нужно ничего** - просто платит картой, аккаунт ЮKassa не требуется

### Для владельца сайта (сейчас)

✅ **Нужен один аккаунт ЮKassa** - для приема всех платежей

### Для музыкантов-продавцов (будущее)

**Вариант 1 (проще):**

- Музыканту не нужен аккаунт ЮKassa
- Владелец платформы получает деньги и распределяет

**Вариант 2 (правильнее):**

- Музыканту нужен свой аккаунт ЮKassa
- Подключение через OAuth в кабинете
- Каждый музыкант получает деньги напрямую

### Что сделать сейчас

1. ✅ Подготовить структуру БД для хранения настроек платежей
2. ✅ Создать API для подключения платежных систем через OAuth
3. ✅ Модифицировать `create-payment.ts` для работы с индивидуальными аккаунтами
4. ✅ Создать UI компонент "Настройки платежей" в кабинете пользователя

## Документация ЮKassa OAuth

Для реализации OAuth авторизации потребуется:

1. Регистрация приложения в ЮKassa (получение `client_id` и `client_secret`)
2. Настройка redirect URI в личном кабинете ЮKassa
3. Реализация OAuth flow:
   - Перенаправление на страницу авторизации ЮKassa
   - Получение `authorization_code`
   - Обмен кода на `access_token`
   - Получение `shopId` и `secretKey` через API ЮKassa
   - Сохранение в БД

**Ссылки:**

- [Документация ЮKassa API](https://yookassa.ru/developers/api)
- [OAuth 2.0 авторизация](https://yookassa.ru/developers/using-api/oauth)
