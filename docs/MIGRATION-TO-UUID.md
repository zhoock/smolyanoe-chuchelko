# Миграция с 'zhoock' на UUID для файлов Storage

## Обзор

Эта миграция переносит систему хранения файлов с хардкода `'zhoock'` на использование UUID пользователя из токена. Это необходимо для поддержки мультипользовательской системы (социальной сети).

## Что было изменено

### Удален хардкод `'zhoock'` из:

1. **`src/shared/api/storage/index.ts`** - функция `getStoragePath()` теперь использует UUID для всех категорий
2. **`netlify/functions/upload-file.ts`** - серверная функция использует UUID из токена
3. **`netlify/functions/get-stem-upload-url.ts`** - использует UUID из токена
4. **`netlify/functions/delete-stem.ts`** - использует UUID из токена
5. **`netlify/functions/delete-hero-image.ts`** - использует UUID из токена
6. **`netlify/functions/commit-cover.ts`** - использует UUID из токена
7. **`netlify/functions/get-track-upload-url.ts`** - использует UUID из токена
8. **`netlify/functions/download-track.ts`** - использует UUID из токена или определяет по альбому
9. **`src/pages/UserDashboard/components/mixer/MixerAdmin.tsx`** - использует UUID из пропсов
10. **`src/pages/UserDashboard/UserDashboard.tsx`** - убран fallback на `'zhoock'`

### Временно оставлен fallback `'zhoock'` в:

- **`src/pages/StemsPlayground/StemsPlayground.tsx`** - публичная страница, требует отдельной логики для получения userId (TODO)

## Структура файлов до и после

### До миграции:

```
users/
  zhoock/
    hero/
    audio/
    stems/
    albums/
    articles/
    profile/
```

### После миграции:

```
users/
  {UUID_пользователя}/
    hero/
    audio/
    stems/
    albums/
    articles/
    profile/
```

## Инструкция по миграции

### Шаг 1: Запуск скрипта миграции

Скрипт `scripts/migrate-zhoock-to-uuid.ts` автоматически:

1. Находит UUID пользователя по email `zhoock@zhoock.ru`
2. Копирует все файлы из `users/zhoock/` в `users/{UUID}/`
3. Сохраняет старые файлы (не удаляет автоматически для безопасности)

```bash
npx tsx scripts/migrate-zhoock-to-uuid.ts
```

### Шаг 2: Проверка результатов

После миграции проверьте:

- ✅ Файлы скопированы в новую папку `users/{UUID}/`
- ✅ Сайт работает корректно
- ✅ Изображения и аудио загружаются
- ✅ Админка работает (Mixer, загрузка файлов)

### Шаг 3: Обновление StemsPlayground (опционально)

После миграции нужно обновить `src/pages/StemsPlayground/StemsPlayground.tsx`:

1. Получить userId из контекста/Redux (если пользователь авторизован)
2. Для публичного доступа - определить userId по альбому или использовать fallback

```typescript
// Пример (нужно адаптировать под вашу архитектуру)
const user = getUser();
const storageUserId = user?.id || getUserIdFromAlbums(albums) || 'fallback';
```

### Шаг 4: Удаление старых файлов

**⚠️ ВАЖНО:** Удаляйте старые файлы только после полной проверки работы сайта!

В Supabase Storage UI удалите папку `users/zhoock/` после того, как убедитесь, что:

- Все файлы скопированы
- Сайт работает корректно
- Нет ошибок в консоли

## Обратная совместимость

После миграции:

- ✅ Новые загрузки файлов будут использовать UUID
- ✅ Старые файлы в `users/zhoock/` останутся доступными до удаления
- ⚠️ Ссылки в базе данных на старые пути нужно обновить (если есть)

## Если что-то пошло не так

1. **Проверьте логи миграции** - скрипт выводит подробную информацию о процессе
2. **Проверьте UUID пользователя** - убедитесь, что пользователь `zhoock@zhoock.ru` существует в БД
3. **Откат**: Старые файлы не удаляются автоматически, можно вернуть код к использованию `'zhoock'` (но это не рекомендуется)

## Следующие шаги

После успешной миграции:

1. ✅ Обновить логику в `StemsPlayground` для работы с UUID
2. ✅ Обновить ссылки в базе данных (если есть прямые ссылки на `users/zhoock/`)
3. ✅ Удалить старые файлы после проверки
4. ✅ Обновить документацию для новых пользователей
